<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distributed Gadget Sync</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 2rem;
      background: #f5f5f5;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: #2563eb;
    }

    .subtitle {
      color: #666;
      font-size: 0.9rem;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 1rem;
    }

    .status.connected {
      background: #dcfce7;
      color: #166534;
    }

    .status.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }

    .card {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .card h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #1f2937;
    }

    .state-display {
      background: #f9fafb;
      padding: 1.5rem;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      font-size: 1.5rem;
      font-weight: 600;
      color: #2563eb;
      text-align: center;
      min-height: 4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .state-display.empty {
      color: #9ca3af;
      font-style: italic;
      font-weight: normal;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    button {
      flex: 1;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #10b981;
      color: white;
    }

    .btn-secondary:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    .info h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 0.5rem;
    }

    .info ul {
      list-style: none;
      font-size: 0.85rem;
      color: #1e40af;
    }

    .info li {
      padding: 0.25rem 0;
      padding-left: 1.5rem;
      position: relative;
    }

    .info li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat {
      background: #f9fafb;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2563eb;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåê Distributed Gadget Sync</h1>
      <p class="subtitle">Real-time state synchronization across multiple tabs using protocol-generic adapters</p>
      <span id="status" class="status disconnected">Disconnected</span>
    </header>

    <div class="card">
      <h2>Shared State (Set&lt;number&gt;)</h2>
      <div id="state" class="state-display empty">Connecting...</div>

      <div class="controls">
        <button class="btn-primary" onclick="addRandom()">‚ûï Add Random Value</button>
        <button class="btn-secondary" onclick="addSequence()">üìä Add Sequence (1-5)</button>
        <button class="btn-danger" onclick="clearState()">üóëÔ∏è Clear All</button>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="valueCount">0</div>
          <div class="stat-label">Values</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="updateCount">0</div>
          <div class="stat-label">Updates</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="clientId">-</div>
          <div class="stat-label">Client ID</div>
        </div>
      </div>

      <div class="info">
        <h3>üí° Try this:</h3>
        <ul>
          <li>Open this page in multiple tabs or windows</li>
          <li>Add values in any tab - they appear everywhere instantly</li>
          <li>Add the same value multiple times - ignored (idempotent)</li>
          <li>Add values in different tabs simultaneously - they merge correctly</li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    // This would normally import from built package
    // For demo purposes, we'll inline the necessary code

    let ws = null;
    let localState = new Set();
    let updateCount = 0;
    const clientId = Math.random().toString(36).substring(2, 6).toUpperCase();

    document.getElementById('clientId').textContent = clientId;

    function connect() {
      ws = new WebSocket('ws://localhost:8080');

      ws.onopen = () => {
        console.log('[Client] Connected to server');
        document.getElementById('status').className = 'status connected';
        document.getElementById('status').textContent = 'Connected';
      };

      ws.onclose = () => {
        console.log('[Client] Disconnected from server');
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('status').textContent = 'Disconnected';

        // Reconnect after 2 seconds
        setTimeout(connect, 2000);
      };

      ws.onerror = (err) => {
        console.error('[Client] WebSocket error:', err);
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);

          // Handle either raw array or effects object with changed field
          let values;
          if (Array.isArray(data)) {
            values = data;
          } else if (data.changed && Array.isArray(data.changed)) {
            values = data.changed;
          } else {
            console.log('[Client] Received unknown format:', data);
            return;
          }

          // Update local state
          localState = new Set(values);
          updateState();
          updateCount++;
          document.getElementById('updateCount').textContent = updateCount;

          console.log('[Client] State updated:', Array.from(localState));
        } catch (e) {
          console.error('[Client] Failed to parse message:', e, event.data);
        }
      };
    }

    function updateState() {
      const stateEl = document.getElementById('state');
      const valueCountEl = document.getElementById('valueCount');

      if (localState.size === 0) {
        stateEl.textContent = '(empty set)';
        stateEl.className = 'state-display empty';
      } else {
        const sorted = Array.from(localState).sort((a, b) => a - b);
        stateEl.textContent = `{ ${sorted.join(', ')} }`;
        stateEl.className = 'state-display';
      }

      valueCountEl.textContent = localState.size;
    }

    function sendUpdate(newValues) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        // Merge new values with local state
        const merged = new Set([...localState, ...newValues]);

        // Send to server
        ws.send(JSON.stringify(Array.from(merged)));

        console.log(`[Client ${clientId}] Sent update:`, Array.from(newValues));
      }
    }

    window.addRandom = () => {
      const value = Math.floor(Math.random() * 100);
      sendUpdate([value]);
    };

    window.addSequence = () => {
      sendUpdate([1, 2, 3, 4, 5]);
    };

    window.clearState = () => {
      if (confirm('Clear all values? This will affect all connected clients.')) {
        // Note: unionCell ignores subsets, so we can't actually "clear"
        // This would require a different cell type (lastCell) or a reset command
        alert('Clear not supported with unionCell (monotonic operation)\n\nUnion cells only grow - they can\'t shrink!\n\nThis demonstrates the ACI property: union is monotonic.');
      }
    };

    // Connect on load
    connect();
  </script>
</body>
</html>
